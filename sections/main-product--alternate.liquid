{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign compare_at_price = current_variant.compare_at_price
  assign price = current_variant.price
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
  assign first_3d_model = product.media | where: 'media_type', 'model' | first
  assign show_share_buttons = section.settings.show_share_buttons

  assign quick_purchase_bar_enabled = false

  if section.settings.enable_quick_purchase_bar and current_variant.available
    assign quick_purchase_bar_enabled = true
  endif

  assign file_extension = 'png'
  assign chip_options = settings.chip_options | downcase | split: ', '
  assign swatch_options = settings.swatch_options | downcase | split: ', '

  assign button_options = swatch_options | concat: chip_options
-%}

{% comment %} This should be made into a reusable snippet {% endcomment %}
{% capture social_share %}
  <button
    type="button"
    class="product__share product__block product__block--medium btn btn--secondary btn--medium-small"
    data-social-share
    aria-haspopup="true"
  >
    <span class="product__share-text fs-body-small fs-body-bold">
      {%- render 'icon' with icon: 'social-share' -%}
      {{ 'general.social.share' | t }}
    </span>

    <div class="product__share-icons" aria-hidden="true" aria-label="{{ 'general.social.alt_text.share_menu' | t }}">
      {% render 'share-icons' with
        url: product.url,
        title: product.title,
        image: product.featured_image
      %}
    </div>
  </button>
{% endcapture %}

<div
  class="product"
  data-section-id="{{ section.id }}"
  data-section-type="product"
  data-current-product-id="{{ current_variant }}"
  data-product-has-only-default-variant="{{ product.has_only_default_variant }}"
  data-quick-purchase-bar-enabled="{{ quick_purchase_bar_enabled }}"
>
  <div class="product__top">
    <div class="product__media-container">
      <div class="product__media">
        {%- for media in product.media -%}
          <div
            class="product__media-item {% unless media.id == featured_media.id %} hidden{% endunless %}"
            data-media-item-id="{{ media.id }}"
            data-product-media-wrapper
          >
            {% render 'media',
              media: media,
              featured_media: featured_media,
              loop_video: section.settings.enable_video_looping
            %}
          </div>
        {%- else -%}
          <div class="product__media-item placeholder-image">
            {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {%- endfor -%}
      </div>

      {%- if first_3d_model -%}
        <button
          aria-label="{{ 'products.product.view_in_space_label' | t }}"
          class="product__view-in-space btn btn--full"
          data-in-your-space
          data-shopify-xr
          data-shopify-model3d-id="{{ first_3d_model.id }}"
          data-shopify-title="{{ product.title | escape }}"
          data-shopify-xr-hidden
        >
          <span>
            {% render 'icon' with icon: '3d' %}
            <span class="product__view-in-space-text">{{ 'products.product.view_in_space' | t }}</span>
          </span>
        </button>
      {%- endif -%}

      {% render 'product-thumbnails' with featured_media: featured_media %}
    </div>

    <div class="product__details">
      <div class="product__meta">
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when '@app' -%}
              {% render block %}

            {%- when 'border' -%}
              <div class="product__border"></div>

            {%- when 'title' -%}
              <h1 class="product__title product__block product__block--small ff-heading fs-heading-2-large fs-heading-1-base-ns">
                {{ product.title }}
              </h1>

            {%- when 'price' -%}
              <div class="product__price product__block product__block--small">
                <span class="fs-heading-4-base" data-price>{{ current_variant.price | money }}</span>

                <span class="visually-hidden" data-compare-text>{{ 'products.product.regular_price' | t }}</span>
                <s data-compare-price>
                  {%- if current_variant.compare_at_price > current_variant.price -%}
                    {{ current_variant.compare_at_price | money }}
                  {%- endif -%}
                </s>
                {% render 'unit-price', item: current_variant %}
              </div>

            {%- when 'sku' -%}
              <div class="product__sku product__block product__block--small" data-product-sku>
                {% if current_variant.sku != blank %}
                  {{ 'products.product.sku_with_value' | t: value: current_variant.sku }}
                {% endif %}
              </div>

            {%- when 'vendor' -%}
              <div class="product__vendor product__block product__block--small btn btn--text-link">
                {{ product.vendor | link_to_vendor }}
              </div>

            {%- when 'variant_picker' -%}
              {%- unless product.has_only_default_variant -%}
                {%- liquid
                  assign label_classes = 'ff-heading fs-heading-4-base'

                  unless block.settings.show_labels
                    assign label_classes = label_classes | append: ' visually-hidden'
                  endunless

                  assign variant_popup_page = pages[block.settings.variant_popup_page]
                  assign variant_popup_content_exists = false
                  assign variant_popup_option = ''

                  if block.settings.variant_popup_option != blank and block.settings.variant_popup_text != blank and variant_popup_page.content != blank
                    assign variant_popup_content_exists = true
                    assign variant_popup_option = block.settings.variant_popup_option | downcase
                  endif
                -%}

                <div class="product__controls-group product__block product__block--medium">
                  {%- for option in product.options_with_values -%}
                    {%- liquid
                      assign option_name = option.name | downcase
                      assign show_popup_trigger = false

                      if variant_popup_content_exists and option_name == variant_popup_option
                        assign show_popup_trigger = true
                      endif
                    -%}

                    {% comment %}
                      All inputs that have `name=options[Name]` will be picked up by
                      ProductForm, registered as an option input, and made available
                      at ProductForm.optionsInputs
                    {% endcomment %}
                    {%- capture option_values -%}
                      <select
                        id="Option{{ option.position }}"
                        name="options[{{ option.name | escape }}]"
                        class="input"
                      >
                        {%- for value in option.values -%}
                          <option
                            value="{{ value | escape }}"
                            {%- if option.selected_value == value -%}selected="selected"{%- endif -%}>
                              {{ value }}
                          </option>
                        {%- endfor -%}
                      </select>
                    {%- endcapture -%}

                    <div class="js-enabled product__option">
                      <div class="product__label-wrapper {% if show_popup_trigger == false and block.settings.show_labels == false %} product__label-wrapper--collapse{% endif %}">
                        <label class="product__label {{ label_classes }}" for="Option{{ option.position }}">
                          {{ option.name }}
                        </label>

                        {% if show_popup_trigger %}
                          <button
                            type="button"
                            class="variant-popup__trigger btn btn--text-link"
                            data-variant-popup-trigger
                            data-modal-content-id="modal-{{ block.settings.variant_popup_page }}"
                          >
                            {{ block.settings.variant_popup_text }}
                          </button>
                          <div
                            id="modal-{{ block.settings.variant_popup_page }}"
                            class="variant-popup__content modal-content"
                          >
                            <h2 class="ff-heading fs-heading-2-large">{{ variant_popup_page.title }}</h2>
                            {{ variant_popup_page.content }}
                          </div>
                        {% endif %}
                      </div>

                      {%- if swatch_options contains option_name -%}
                        <!-- Handle swatches -->
                        <div
                          class="product__color-swatches"
                          data-option-buttons
                          data-product-option="Option{{ option.position }}"
                        >
                          {%- for value in option.values -%}
                            <button
                              type="button"
                              data-label="{{ value }}"
                              aria-label="{{ value }}"
                              data-button="{{ value }}"
                              class="product__color-swatch {% if option.selected_value == value %}selected{% endif %}"
                              style="background-color: {{ value | lowercase | replace: ' ', '' }}; background-image: url({{ value | handle | append: '.' | append: file_extension | file_url }})"
                            ></button>
                          {%- endfor -%}

                          {{ option_values }}
                        </div>
                      {%- endif -%}

                      {%- if chip_options contains option_name -%}
                        <!-- Handle chips -->
                        <div
                          class="product__color-chips"
                          data-option-buttons
                          data-product-option="Option{{ option.position }}"
                        >
                          {%- for value in option.values -%}
                            <button
                              type="button"
                              data-button="{{ value }}"
                              class="product__chip {% if option.selected_value == value %}selected{% endif %}"
                            >
                              {{ value }}
                            </button>
                          {%- endfor -%}

                          {{ option_values }}
                        </div>
                      {%- endif -%}

                      {%- unless button_options contains option_name -%}
                        <div class="select-wrapper">
                          {{ option_values }}

                          {% render 'icon' with icon: 'triangle' %}
                        </div>
                      {%- endunless -%}
                    </div>
                  {% endfor %}
                </div>
              {% endunless %}

            {%- when 'quantity_selector' -%}
              {% assign label_classes = 'ff-heading fs-heading-4-base' %}

              {%- unless block.settings.show_labels -%}
                {% assign label_classes = label_classes | append: ' visually-hidden' %}
              {%- endunless -%}

              <div class="product__controls-group product__controls-group-quanity product__block product__block--medium">
                <div class="product__label-wrapper{% unless block.settings.show_labels %} product__label-wrapper--collapse{% endunless %}">
                  <label class="product__label {{ label_classes }}" for="Quantity-{{ product.id }}">
                    {{ 'products.product.quantity' | t }}
                  </label>
                </div>
                <div class="product__item product__quantity">
                  <button
                    type="button"
                    class="product__quantity-button product__quantity-subtract-item"
                    data-subtract-quantity
                    aria-label="{{ 'general.accessibility.quantity_add' | t }}"
                  >
                    {% render 'icon' with icon: 'minus' true, non_focusable: true %}
                  </button>
                  <input
                    type="number"
                    id="Quantity-{{ product.id }}"
                    name="quantity"
                    value="1"
                    min="1"
                    pattern="[0-9]*"
                    class="product__input product__input--quantity"
                    data-quantity-input
                    aria-label="{{ 'general.accessibility.quantity' | t }}"
                  >
                  <button
                    type="button"
                    class="product__quantity-button product__quantity-add-item"
                    data-add-quantity
                    aria-label="{{ 'general.accessibility.quantity_subtract' | t }}"
                  >
                    {% render 'icon' with icon: 'plus', non_focusable: true %}
                  </button>
                </div>
              </div>

              <div class="product__quantity-error hidden" data-quantity-error>
                {{ 'products.product.quantity_error' | t }}
              </div>

            {%- when 'buy_buttons' -%}
              {%
                render 'product-form' with
                product: product,
                current_variant: current_variant,
                show_dynamic_checkout: block.settings.show_dynamic_checkout,
              %}

              {%- if shop.taxes_included or shop.shipping_policy.body != blank -%}
                <div class="product__policies rte" data-product-policies>
                  {%- if shop.taxes_included -%}
                    {{ 'products.product.include_taxes' | t }}
                  {%- endif -%}
                  {%- if shop.shipping_policy.body != blank -%}
                    {{ 'products.product.shipping_policy_html' | t: link: shop.shipping_policy.url }}
                  {%- endif -%}
                </div>
              {%- endif -%}

            {%- when 'share' -%}
              {{ social_share }}

            {%- when 'text' -%}
              <div class="product__text product__block product__block--medium">
                <div class="product__text-content rte rte--product ff-body fs-body-small">
                  {{ block.settings.text }}
                </div>
              </div>

            {%- when 'inventory-counter' -%}
              {%-
                render 'inventory-counter' with
                product: product,
                show_label: block.settings.show_label,
                inventory_max: block.settings.inventory_max,
                low_inventory_threshold: block.settings.low_inventory_threshold,
                current_variant: current_variant,
              -%}

            {%- when 'accordion' -%}
              {%- assign accordion_class = 'rte--product accordion--product product__block product__block--small'
                | append: ' accordion--'
                | append: block.settings.style
              -%}
              {%-
                render 'accordion-block' with
                block: block,
                classes: accordion_class,
                small_text: true,
                heading: block.settings.heading,
                content: block.settings.content
              -%}
          {%- endcase -%}
        {%- endfor -%}

        {%- comment -%}
          Live region for announcing updated price and availability to screen readers
        {%- endcomment -%}
        <p
          class="visually-hidden"
          data-product-status
          aria-live="polite"
          role="status"
        ></p>

        {%- comment -%}
          Live region for announcing that the product form has been submitted and the
          product is in the process being added to the cart
        {%- endcomment -%}
        <p
          class="visually-hidden"
          data-loader-status
          aria-live="assertive"
          role="alert"
          aria-hidden="true"
        >
          {{ 'products.product.loader_label' | t }}
        </p>
      </div>
    </div>
  </div>

  {%- assign images = product.media | where: 'media_type', 'image' -%}
  {% render 'lightbox' with images: images %}
  {%- if quick_purchase_bar_enabled -%}
    {% render 'quick-purchase-bar' with product: product, show_share_buttons: show_share_buttons %}
  {%- endif -%}
</div>

{%- assign models = product.media | where: 'media_type', 'model' | json -%}

<script>
  window.ShopifyXR=window.ShopifyXR||function(){(ShopifyXR.q=ShopifyXR.q||[]).push(arguments)}
  ShopifyXR('addModels', {{ models }});
</script>
<script src="//cdn.shopify.com/shopifycloud/shopify-xr-js/assets/v1.0/shopify-xr.en.js" defer="defer"></script>

{%- unless product == empty -%}
  <script type="application/json" id="ProductJson-{{ section.id }}">
    {{ product | json }}
  </script>
  <script type="application/json" id="ModelJson-{{ section.id }}">
    {{ product.media | where: 'media_type', 'model' | json }}
  </script>
{%- endunless -%}

<script type="application/ld+json">
  {
    "@context": "http://schema.org/",
    "@type": "Product",
    "name": {{ product.title | json }},
    "url": {{ shop.url | append: product.url | json }},
    {%- if product.featured_media -%}
      {%- assign media_size = product.featured_media.preview_image.width | append: 'x' -%}
      "image": [
        {{ product.featured_media | img_url: media_size | prepend: "https:" | json }}
      ],
    {%- endif -%}
    "description": {{ product.description | strip_html | json }},
    {%- if current_variant.sku != blank -%}
      "sku": {{ current_variant.sku | json }},
    {%- endif -%}
    "brand": {
      "@type": "Thing",
      "name": {{ product.vendor | json }}
    },
    "offers": [
      {%- for variant in product.variants -%}
        {
          "@type" : "Offer",
          {%- if variant.sku != blank -%}
            "sku": {{ variant.sku | json }},
          {%- endif -%}
          "availability" : "http://schema.org/{% if variant.available %}InStock{% else %}OutOfStock{% endif %}",
          "price" : {{ variant.price | divided_by: 100.00 | json }},
          "priceCurrency" : {{ cart.currency.iso_code | json }},
          "url" : {{ shop.url | append: variant.url | json }}
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ]
  }
</script>

{% schema %}
{
  "name": "t:sections.main_product_overview.name",
  "tag": "section",
  "class": "product--alternate",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.main_product_overview.settings.purchase_bar__header.content"
    },
    {
      "type": "checkbox",
      "id": "enable_quick_purchase_bar",
      "label": "t:sections.main_product_overview.settings.enable_quick_purchase_bar.label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_share_buttons",
      "label": "t:sections.main_product_overview.settings.show_share_buttons.label",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.main_product_overview.settings.media__header.content"
    },
    {
      "type": "paragraph",
      "content": "t:sections.main_product_overview.settings.media__paragraph.content"
    },
    {
      "id": "enable_video_looping",
      "type": "checkbox",
      "label": "t:sections.main_product_overview.settings.enable_video_looping.label",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "border",
      "name": "t:sections.main_product_overview.blocks.border.name"
    },
    {
      "type": "title",
      "name": "t:sections.main_product_overview.blocks.title.name",
      "limit": 1
    },
    {
      "type": "price",
      "name": "t:sections.main_product_overview.blocks.price.name",
      "limit": 1
    },
    {
      "type": "sku",
      "name": "t:sections.main_product_overview.blocks.sku.name",
      "limit": 1
    },
    {
      "type": "vendor",
      "name": "t:sections.main_product_overview.blocks.vendor.name",
      "limit": 1
    },
    {
      "type": "quantity_selector",
      "name": "t:sections.main_product_overview.blocks.quantity_selector.name",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_labels",
          "label": "t:sections.main_product_overview.blocks.quantity_selector.settings.show_labels.label",
          "default": true
        }
      ]
    },
    {
      "type": "variant_picker",
      "name": "t:sections.main_product_overview.blocks.variant_picker.name",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_labels",
          "label": "t:sections.main_product_overview.blocks.variant_picker.settings.show_labels.label",
          "default": true
        },
        {
          "type": "header",
          "content": "t:sections.main_product_overview.blocks.variant_picker.settings.popup__header.content",
          "info": "t:sections.main_product_overview.blocks.variant_picker.settings.popup__header.info"
        },
        {
          "type": "text",
          "id": "variant_popup_option",
          "label": "t:sections.main_product_overview.blocks.variant_picker.settings.variant_popup_option.label",
          "info": "t:sections.main_product_overview.blocks.variant_picker.settings.variant_popup_option.info",
          "default": "Size"
        },
        {
          "type": "text",
          "id": "variant_popup_text",
          "label": "t:sections.main_product_overview.blocks.variant_picker.settings.variant_popup_text.label",
          "default": "Size guide"
        },
        {
          "type": "page",
          "id": "variant_popup_page",
          "label": "t:sections.main_product_overview.blocks.variant_picker.settings.variant_popup_page.label",
          "info": "t:sections.main_product_overview.blocks.variant_picker.settings.variant_popup_page.info"
        }
      ]
    },
    {
      "type": "buy_buttons",
      "name": "t:sections.main_product_overview.blocks.buy_buttons.name",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "default": true,
          "label": "t:sections.main_product_overview.blocks.buy_buttons.settings.show_dynamic_checkout.label",
          "info": "t:sections.main_product_overview.blocks.buy_buttons.settings.show_dynamic_checkout.info"
        }
      ]
    },
    {
      "type": "text",
      "name": "t:sections.main_product_overview.blocks.text.name",
      "limit": 1,
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "t:sections.main_product_overview.blocks.text.settings.text.label",
          "default": "<p>Add some text to tell customers more about your product.</p>"
        }
      ]
    },
    {
      "type": "share",
      "name": "t:sections.main_product_overview.blocks.share.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.main_product_overview.blocks.share.settings.paragraph__1.content"
        },
        {
          "type": "paragraph",
          "content": "t:sections.main_product_overview.blocks.share.settings.paragraph__2.content"
        }
      ]
    },
    {
      "type": "inventory-counter",
      "name": "t:sections.main_product_overview.blocks.inventory_counter.name",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_label",
          "label": "t:sections.main_product_overview.blocks.inventory_counter.settings.show_labels.label",
          "default": true
        },
        {
          "type": "text",
          "id": "inventory_max",
          "label": "t:sections.main_product_overview.blocks.inventory_counter.settings.inventory_max.label",
          "info": "t:sections.main_product_overview.blocks.inventory_counter.settings.inventory_max.info",
          "default": "100"
        },
        {
          "type": "text",
          "id": "low_inventory_threshold",
          "label": "t:sections.main_product_overview.blocks.inventory_counter.settings.low_inventory_threshold.label",
          "info": "t:sections.main_product_overview.blocks.inventory_counter.settings.low_inventory_threshold.info",
          "default": "40"
        }
      ]
    },
    {
      "type": "accordion",
      "name": "t:sections.main_product_overview.blocks.accordion.name",
      "settings": [
        {
          "id": "style",
          "label": "t:sections.main_product_overview.blocks.accordion.settings.style.label",
          "type": "select",
          "default": "closed",
          "options": [
            {
              "value": "open",
              "label": "t:sections.main_product_overview.blocks.accordion.settings.style.options__1"
            },
            {
              "value": "closed",
              "label": "t:sections.main_product_overview.blocks.accordion.settings.style.options__2"
            }
          ]
        },
        {
          "type": "text",
          "id": "heading",
          "label": "t:sections.main_product_overview.blocks.accordion.settings.heading.label",
          "info": "t:sections.main_product_overview.blocks.accordion.settings.heading.info",
          "default": "Accordion heading"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "t:sections.main_product_overview.blocks.accordion.settings.content.label"
        }
      ]
    }
  ]
}
{% endschema %}
